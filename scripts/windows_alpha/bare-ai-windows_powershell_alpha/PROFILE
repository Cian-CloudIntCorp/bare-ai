# =============================================================================
# SCRIPT: setup_bare_ai_windows.ps1
# VERSION: 2.1.0
# DESCRIPTION: Enterprise Deployment for BARE-AI Autonomous Agent
# AUTHOR: DevOps Engineering / Gemini AI
# =============================================================================
# This script initializes the environment for the BARE-AI Autonomous Agent.
# It performs the following enterprise-grade actions:
# 1. System Audit: Checks for Gemini CLI and required runtimes.
# 2. Workspace Provisioning: Creates .bare-ai, diary, and logs directories.
# 3. Logic Injection: Deploys the 'Constitution' (System Prompt).
# 4. Documentation: Generates a 100+ line README with embedded functions.
# 5. Profile Integration: Detects and prepares the PowerShell profile.
# =============================================================================

# --- Global Configuration ---
$USER_PROFILE   = $env:USERPROFILE
$BARE_AI_DIR    = Join-Path $USER_PROFILE ".bare-ai"
$DIARY_DIR      = Join-Path $BARE_AI_DIR "diary"
$LOGS_DIR       = Join-Path $BARE_AI_DIR "logs"
$CONST_PATH     = Join-Path $BARE_AI_DIR "constitution.md"
$README_PATH    = Join-Path $BARE_AI_DIR "README.md"
$GEMINI_CLI_CMD = "gemini"

# -----------------------------------------------------------------------------
# FUNCTION: Write-EnterpriseLog
# Provides standardized, timestamped, and colored output for audit trails.
# -----------------------------------------------------------------------------
function Write-EnterpriseLog {
    param(
        [Parameter(Mandatory=$true)][string]$Message,
        [Parameter(Mandatory=$true)][ValidateSet("Green", "Yellow", "Red", "Cyan", "Gray")]$Status
    )
    $colors = @{ "Green"="Green"; "Yellow"="Yellow"; "Red"="Red"; "Cyan"="Cyan"; "Gray"="Gray" }
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $originalColor = $Host.UI.RawUI.ForegroundColor
   
    $Host.UI.RawUI.ForegroundColor = $colors[$Status]
    Write-Host "[$timestamp] [$Status] $Message"
    $Host.UI.RawUI.ForegroundColor = $originalColor
}

# -----------------------------------------------------------------------------
# STEP 1: PRE-FLIGHT SYSTEM AUDIT
# -----------------------------------------------------------------------------
Write-EnterpriseLog -Message "Starting BARE-AI Pre-flight Audit..." -Status Cyan

$cliCommand = Get-Command $GEMINI_CLI_CMD -ErrorAction SilentlyContinue

if (-not $cliCommand) {
    Write-EnterpriseLog -Message "CRITICAL: Gemini CLI Core not detected." -Status Red
    Write-EnterpriseLog -Message "Please ensure one of the following is installed:" -Status Yellow
    Write-EnterpriseLog -Message "  - Python Vector: pip install google-generativeai" -Status Gray
    Write-EnterpriseLog -Message "  - Node Vector: npm install -g @google/gemini-cli" -Status Gray
    Write-EnterpriseLog -Message "Action: Install dependency and restart PowerShell session." -Status Red
    exit 1
} else {
    Write-EnterpriseLog -Message "Gemini CLI Binary verified at: $($cliCommand.Source)" -Status Green
}

# -----------------------------------------------------------------------------
# STEP 2: INFRASTRUCTURE PROVISIONING
# -----------------------------------------------------------------------------
Write-EnterpriseLog -Message "Provisioning BARE-AI Workspace..." -Status Cyan

$infrastructurePaths = @($BARE_AI_DIR, $DIARY_DIR, $LOGS_DIR)

foreach ($path in $infrastructurePaths) {
    if (-not (Test-Path $path)) {
        try {
            New-Item -ItemType Directory -Force -Path $path | Out-Null
            Write-EnterpriseLog -Message "Successfully provisioned path: $path" -Status Green
        } catch {
            Write-EnterpriseLog -Message "FAILED to provision path: $path. Error: $($_.Exception.Message)" -Status Red
            exit 1
        }
    } else {
        Write-EnterpriseLog -Message "Path exists: $path" -Status Gray
    }
}

# -----------------------------------------------------------------------------
# STEP 3: CONSTITUTION (SYSTEM PROMPT) DEPLOYMENT
# -----------------------------------------------------------------------------
Write-EnterpriseLog -Message "Injecting Agent Constitution..." -Status Cyan

$constitutionContent = @"
# BARE-AI AGENT CONSTITUTION
# VERSION: 1.0.0
# UPDATED: $(Get-Date -Format "yyyy-MM-dd")

MISSION: You are an autonomous Linux Agent for "Self-Healing" pipelines.
OPERATIONAL GUIDELINES:
1. UPDATES: Always use 'sudo DEBIAN_FRONTEND=noninteractive' for apt/dnf.
2. VALIDATION: Perform md5sum or JSON schema validation on all critical files.
3. LOGGING: Maintain a persistent session log in ~/.bare-ai/diary/{{DATE}}.md.
4. ERROR HANDLING: If a command fails twice, pivot to diagnostic mode.
"@

try {
    $constitutionContent | Set-Content -Path $CONST_PATH -Encoding UTF8 -Force
    Write-EnterpriseLog -Message "Constitution successfully deployed to $CONST_PATH" -Status Green
} catch {
    Write-EnterpriseLog -Message "CRITICAL ERROR: Failed to write constitution: $($_.Exception.Message)" -Status Red
}

# -----------------------------------------------------------------------------
# STEP 4: DOCUMENTATION GENERATION (README.MD)
# -----------------------------------------------------------------------------
Write-EnterpriseLog -Message "Generating Enterprise Documentation (README.md)..." -Status Cyan

# NOTE: The closing " @ below MUST be flush with the left margin (Column 0).
$readmeContent = @"
# BARE-AI ENTERPRISE CONFIGURATION

This workspace manages the local state, rulesets, and memory for the BARE-AI Agent.

## DIRECTORY STRUCTURE OVERVIEW
- **ROOT**: `$BARE_AI_DIR`
- **CONSTITUTION**: `constitution.md` (Defines Agent Logic/Personality)
- **DIARY**: `diary\` (Daily session logs in Markdown format)
- **LOGS**: `logs\` (Raw execution transcripts)

## AGENT ACTIVATION INSTRUCTIONS

To initialize the agent within your PowerShell environment, follow these steps:

1.  **API Authentication**:
    Obtain your key from Google AI Studio and add it to your profile:
    ```powershell
$MY_KEY = "AIYourKeyHereForNow"

function bare {
    $TODAY = Get-Date -Format "yyyy-MM-dd"
    $BARE_ROOT = Join-Path $env:USERPROFILE ".bare-ai"
    $CONST_FILE = Join-Path $BARE_ROOT "constitution.md"
    $TEMP_PY = Join-Path $env:TEMP "bare_bridge.py"

    if (-not (Test-Path $CONST_FILE)) {
        Write-Error "Constitution missing at $CONST_FILE"
        return
    }

    $promptContent = Get-Content $CONST_FILE -Raw
    $promptContent = $promptContent -replace '{{DATE}}', $TODAY

    @.config/nvm/test/fast/Aliases/'nvm alias' should ignore leading blank lines in the file
import sys, os, subprocess
from google import genai

def run():
    try:
        sys_prompt = sys.argv[1]
        api_key_input = sys.argv[2]
        
        client = genai.Client(api_key=api_key_input)
        print("--- STATUS: CONNECTED TO GEMINI 2.0 ---")
        
        chat = client.chats.create(model="gemini-2.0-flash")
        print("Ready for input. Type EXIT to quit.\n")
        
        while True:
            user_input = input("AGENT > ")
            if user_input.upper() == "EXIT":
                break
            
            full_message = f"{sys_prompt}\n\nUSER REQUEST: {user_input}"
            response = chat.send_message(full_message)
            answer = response.text
            print("\n" + answer + "\n")

            # AUTOMATION LOGIC: Check for PowerShell code blocks
            if "```powershell" in answer.lower():
                code = answer.split("```powershell")[1].split("```")[0].strip()
                confirm = input("CONFIRM: Execute this PowerShell code? (Y/N):")
                
                if confirm.upper() == 'Y':
                    print("--- EXECUTING ---")
                    # Run the extracted code in a real PowerShell process
                    result = subprocess.run(["powershell", "-Command", code], capture_output=True, text=True)
                    
                    # Display result to you
                    if result.stdout: print(f"OUTPUT:\n{result.stdout}")
                    if result.stderr: print(f"ERROR:\n{result.stderr}")
                    
                    # Feed the result back to the AI so it knows if it worked
                    chat.send_message(f"SYSTEM RESULT:\nSTDOUT: {result.stdout}\nSTDERR: {result.stderr}")
                    print("--- SYSTEM STATE UPDATED ---")
    except Exception as e:
        print(f"ERROR: {e}")

if __name__ == "__main__":
    run()
" @ | Out-File -FilePath $TEMP_PY -Encoding utf8 -Force

    Write-Host "--- BARE-AI INITIALIZING ---" -ForegroundColor Cyan
    python $TEMP_PY "$promptContent" "$MY_KEY"
}
