#!/bin/bash
set -e

# --- CONFIGURATION ---
CONSTITUTION="$HOME/.bare-ai/constitution.md"
FLEET_FILE="$HOME/.bare-ai/fleet.conf"
LOG_FILE="$HOME/.bare-ai/reflex_history.log"
TARGET_USER="bare-ai"

# --- CIRCUIT BREAKER ---
should_block_reflex() {
    local target=$1
    local time_pattern=$(date +%Y-%m-%d\ %H:)
    local recent=$(grep "$target" "$LOG_FILE" 2>/dev/null | grep "REFLEX" | grep "$time_pattern" | tail -n 1)
    if [[ -n "$recent" ]]; then echo "YES"; else echo "NO"; fi
}

# --- MAIN LOOP ---
echo "ðŸ§  Brain: Scanning Fleet..."

while IFS= read -r WORKER_HOST || [[ -n "$WORKER_HOST" ]]; do
    [[ "$WORKER_HOST" =~ ^#.*$ ]] && continue
    [[ -z "$WORKER_HOST" ]] && continue
    
    echo -e "\nðŸ“¡ Targeting: $WORKER_HOST"
    
    # 1. HARVEST
    RAW_DATA=$(ssh -q -o ConnectTimeout=5 $TARGET_USER@$WORKER_HOST "bare-summarize" || echo "")
    if [ -z "$RAW_DATA" ]; then echo "âŒ Unreachable."; continue; fi

    # 2. CIRCUIT BREAKER
    if [[ $(should_block_reflex "$WORKER_HOST") == "YES" ]]; then
        echo "âš ï¸  Circuit Breaker: Skipping $WORKER_HOST (Already fixed this hour)."
        continue
    fi

    # 3. ANALYZE (Hybrid: Gemini + Spinal Cord)
    PROMPT="Review JSON from $WORKER_HOST. If 'rke2_status' is 'inactive', output command (e.g., 'COMMAND: sudo systemctl start rke2-server'). Else 'COMMAND: NONE'. DATA: $RAW_DATA"
    
    # Try Gemini, fail silently to local logic
    RESPONSE=$(gemini -m gemini-2.5-flash-lite "$PROMPT" 2>/dev/null || echo "")

    # Fallback (Spinal Cord)
    if [ -z "$RESPONSE" ]; then
        echo "âš ï¸  Offline Mode: Engaging Spinal Cord."
        if echo "$RAW_DATA" | grep -q '"rke2_status": "inactive"'; then
            RESPONSE="COMMAND: sudo systemctl start rke2-server"
        else
            RESPONSE="COMMAND: NONE"
        fi
    fi

    # 4. REFLEX
    FIX_CMD=$(echo "$RESPONSE" | grep "COMMAND:" | cut -d':' -f2 | xargs)
    if [[ "$FIX_CMD" != "NONE" && ! -z "$FIX_CMD" ]]; then
        echo "âš¡ REFLEX: Executing '$FIX_CMD'"
        ssh -t -q $TARGET_USER@$WORKER_HOST "$FIX_CMD"
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] REFLEX | $WORKER_HOST | $FIX_CMD" >> "$LOG_FILE"
    else
        echo "ðŸŸ¢ Healthy."
    fi
done < "$FLEET_FILE"
